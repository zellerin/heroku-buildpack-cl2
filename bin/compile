#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# parse and derive params
BUILDPACK_DIR=$(cd $(dirname $0); cd ..; pwd) # absolute path of buildpack
BUILD_DIR=$1
CACHE_DIR=$2
SBCL_VERSION=1.4.11

echo "-----> compile params: $BUILD_DIR $CACHE_DIR"

if [ $RESET_CACHE ]; then
  echo "-----> flushing cache"
  rm -rf $CACHE_DIR/*
fi

if [ ! -d "$CACHE_DIR/sbcl/sbcl-${SBCL_VERSION}-x86-64-linux" ]; then
    echo "-----> Fetching sbcl"
    SBCL_PACKAGE="http://prdownloads.sourceforge.net/sbcl/sbcl-${SBCL_VERSION}-x86-64-linux-binary.tar.bz2"
    mkdir -p "$CACHE_DIR/sbcl" && wget $SBCL_PACKAGE -O -  | tar xjf - -C "$CACHE_DIR/sbcl"
    chmod +x "$CACHE_DIR/sbcl/sbcl-${SBCL_VERSION}-x86-64-linux/run-sbcl.sh"
fi
# add to slug 
echo "sbcl installed" | indent

# setting up paths for building

export BUILDPACK_DIR
export CACHE_DIR
export BUILD_DIR
export ASDF_OUTPUT_TRANSLATIONS="/:$CACHE_DIR/$SBCL_VERSION"

echo "-----> Starting build"
$CACHE_DIR/sbcl/sbcl-${SBCL_VERSION}-x86-64-linux/run-sbcl.sh --no-sysinit --no-userinit --load "$BUILDPACK_DIR/bin/compile.lisp"
cp -p $CACHE_DIR/sbcl/sbcl-${SBCL_VERSION}-x86-64-linux/src/runtime/sbcl ${BUILD_DIR}/
echo "-----> Build finished"
